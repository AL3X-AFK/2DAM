create or replace type tipo_direccion as object(
	direccion VARCHAR2(50),
	codigo_postal NUMBER
);
/

create or replace type tipo_contacto as object(
	telefono NUMBER,
	email VARCHAR2(30)
);
/

create or replace type tipo_persona as object(
	id NUMBER,
	nombre VARCHAR2(20),
	apellido VARCHAR2(20),
	direccion tipo_direccion,
	contacto tipo_contacto
)not final;
/

create or replace type tipo_cliente under tipo_persona(
	numero_de_pedidos NUMBER
);
/ 

desc tipo_direccion
desc tipo_contacto;
desc tipo_persona;
desc tipo_cliente;


create or replace type tipo_articulo as object(
	id NUMBER,
	nombre VARCHAR2(20),
	descripcion VARCHAR2(20),
	precio number(7,2),
	porcentaje_de_iva number(4,2)
);
/

create or replace type tipo_tabla_anidada as TABLE of tipo_articulo;
/

desc tipo_articulo;


create or replace type tipo_lista_detalle as object(
	numero number,
	articulo tipo_articulo,
	cantidad number
);
/

create or replace type tab_lista_detalle as table of tipo_lista_detalle;
/

create or replace type tipo_lista_compra as object(
	id number,
	fecha DATE,
	cliente REF tipo_cliente,
	detalle tab_lista_detalle,
	MEMBER  function total_lista_compra return number
);
/



create or replace type body tipo_lista_compra as 
MEMBER function total_lista_compra return number is
	total NUMBER := 0;
BEGIN
	if detalle is not null THEN
		FOR i in 1 .. detalle.COUNT LOOP
			total := total + detalle(i).cantidad * (detalle(i).articulo.precio * (1 * detalle(i).articulo.porcentaje_de_iva/100));
		end LOOP;
	end if;
	return total;
end;
end;
/


create table clientes of tipo_cliente;
insert into clientes VALUES(1, 'Alex', 'Valdez', tipo_direccion('C. Jose, 23', 28026), tipo_contacto(123456789, 'alex@gmail.com'), 0);
insert into clientes VALUES(2, 'Mayra', 'Veloz', tipo_direccion('C. Almudena, 05', 28026), tipo_contacto(789456123, 'mayra@gmail.com'), 0);



create table listas_compra of tipo_lista_compra
NESTED table detalle store as tabla_detalles;

insert into listas_compra 
SELECT
01, 
SYSDATE, 
ref (c),
tab_lista_detalle(
    tipo_lista_detalle(1, tipo_articulo(1, 'PS5', 'Consola', 500, 21), 5),
    tipo_lista_detalle(2, tipo_articulo(2, 'Mando', 'DualSense', 70, 21), 2)
  )
 from clientes c 
 where c.id = 1;
/


select c.id, c.total_lista_compra()
from listas_compra c;